<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Patient Weight Loss Calculator</title>
  <style>
    :root {
      --muted: #64748b; /* slate-500 */
      --text: #1e293b; /* slate-800 */
      --border: #cbd5e1; /* slate-300 */
    }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: #ffffff;
      color: var(--text);
      padding: 5vh 4vw 8vh;
    }
    [role="application"] {
      max-width: 900px;
      margin: 0 auto;
    }
    header { padding: 20px 24px; border-bottom: none; background: #f8fafc; }
    header h1 { margin: 0; font-size: 1.25rem; letter-spacing: .3px; }
    header p { margin: 6px 0 0; color: var(--muted); font-size: .9rem; }

    form { display: grid; gap: 18px; padding: 20px 24px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); box-sizing: border-box; }
    .field { display: grid; gap: 8px; }
    .weight-row { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
    label { font-size: .9rem; color: var(--muted); }
    input[type="number"] { -moz-appearance: textfield; }
    input[type="date"], input[type="text"], select {
      background: #ffffff; color: var(--text);
      border: 1px solid var(--border); border-radius: 12px; padding: 12px 14px; font-size: 1rem;
      outline: none; transition: border-color .2s ease, box-shadow .2s ease;
    }
    input:focus, select:focus { border-color: #64748b; box-shadow: 0 0 0 4px rgba(100,116,139,.2); }

    .actions { display: flex; gap: 12px; padding-left: 24px; padding-right: 24px; padding-bottom: 20px; flex-wrap: wrap; box-sizing: border-box; margin: 0; }
    button {
      border: 1px solid var(--border); background: #f1f5f9; color: var(--text);
      padding: 12px 16px; border-radius: 12px; cursor: pointer; font-weight: 600; letter-spacing: .2px;
      transition: transform .02s ease, background .2s ease, border-color .2s ease;
    }
    button.primary { background: #e2e8f0; border-color: #cbd5e1; }
    button:hover { background: #e2e8f0; }
    button:active { transform: translateY(1px); }

    .results { padding-left: 24px; padding-right: 24px; padding-top: 20px; padding-bottom: 20px; border-top: none; display: grid; gap: 14px; overflow: visible; width: 100%; box-sizing: border-box; margin: 0; }
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 14px; min-width: 0; width: 100%; }
    .card { background: #f8fafc; border: none; border-radius: 16px; padding: 16px; overflow-wrap: break-word; word-wrap: break-word; min-width: 0; width: 100%; box-sizing: border-box; }
    .sub { color: var(--muted); font-size: .9rem; margin-top: 4px; padding: 12px 16px; overflow-wrap: break-word; word-wrap: break-word; white-space: normal; width: 100%; box-sizing: border-box; }

    .note { color: var(--muted); font-size: .85rem; }
    .error { color: #dc2626; }
    .version { position: fixed; bottom: 8px; right: 12px; color: var(--muted); font-size: .7rem; opacity: 0.5; }
  </style>
</head>
<body>
  <div role="application" aria-label="Patient Weight Loss Calculator">
    <header>
      <h1>Patient Weight Loss Calculator</h1>
      <p>Enter weights in kilograms and optionally the date of the last visit. The tool will compute <em>total body weight loss (TBWL%)</em> from the starting weight, and—if provided—<em>TBWL% from a pre‑operative starting weight</em>. If a date of last visit is provided, it will also compute <em>average weekly change</em> since the last visit.</p>
    </header>

    <form id="calc-form" onsubmit="event.preventDefault(); calculate();">

      <div class="field">
        <label for="preopWeight">Pre‑operative starting weight (if applicable)</label>
        <div class="weight-row">
          <input id="preopWeight" name="preopWeight" type="number" step="0.1" min="0" inputmode="decimal" />
          <select id="preopUnit" name="preopUnit">
            <option value="kg" selected>kg</option>
            <option value="lb">lb</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label for="startWeight">Program starting weight</label>
        <div class="weight-row">
          <input id="startWeight" name="startWeight" type="number" step="0.1" min="0" inputmode="decimal" required />
          <select id="startUnit" name="startUnit">
            <option value="kg" selected>kg</option>
            <option value="lb">lb</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label for="aomWeight">AOM starting weight (if different than program starting weight)</label>
        <div class="weight-row">
          <input id="aomWeight" name="aomWeight" type="number" step="0.1" min="0" inputmode="decimal" />
          <select id="aomUnit" name="aomUnit">
            <option value="kg" selected>kg</option>
            <option value="lb">lb</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label for="lastWeight">Last visit weight</label>
        <div class="weight-row">
          <input id="lastWeight" name="lastWeight" type="number" step="0.1" min="0" inputmode="decimal" required />
          <select id="lastUnit" name="lastUnit">
            <option value="kg" selected>kg</option>
            <option value="lb">lb</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label for="currentWeight">Current weight</label>
        <div class="weight-row">
          <input id="currentWeight" name="currentWeight" type="number" step="0.1" min="0" inputmode="decimal" required />
          <select id="currentUnit" name="currentUnit">
            <option value="kg" selected>kg</option>
            <option value="lb">lb</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label for="lastVisitDate">Date of last visit (MMDDYY) - optional</label>
        <input id="lastVisitDate" name="lastVisitDate" type="text" inputmode="numeric" placeholder="MMDDYY" maxlength="6" />
      </div>

      <div class="field">
        <label for="asOfDate">As of (defaults to today, MMDDYY)</label>
        <input id="asOfDate" name="asOfDate" type="text" inputmode="numeric" placeholder="MMDDYY" maxlength="6" />
      </div>

      

      
    </form>

    <div class="actions">
      <button class="primary" onclick="calculate()">Calculate</button>
      <button onclick="resetForm()">Reset</button>
    </div>

    <section class="results" id="results" aria-live="polite">
      <div id="message" class="note">Fill out the fields and click <strong>Calculate</strong>.</div>
      <div class="cards" id="cards" hidden>
        <div class="card">
          <div class="sub" id="sinceSummary"></div>
        </div>
      </div>
    </section>

    

    
    <div class="version">v1.0.0</div>
  </div>

  <script>
  function fmt(num, places) {
    if (!isFinite(num)) return "—";
    return Number(num).toFixed(places);
  }

  // STRICT date parser for MMDDYY or MM/DD/YY
  function parseDate(d) {
    if (!d) return null;
    // Check for MMDDYY format (6 digits, no slashes)
    if (/^\d{6}$/.test(d.trim())) {
      const str = d.trim();
      const mm = str.substring(0, 2);
      const dd = str.substring(2, 4);
      const yy = str.substring(4, 6);
      const month = +mm, day = +dd, y = +yy;
      if (month < 1 || month > 12) return null;
      let year = y >= 50 ? 1900 + y : 2000 + y;
      const dt = new Date(year, month - 1, day);
      if (dt.getMonth() !== month - 1 || dt.getDate() !== day) return null;
      return dt;
    }
    // Check for MM/DD/YY format (backwards compatibility)
    if (d.includes('/')) {
      const parts = d.split('/');
      if (parts.length !== 3) return null;
      let [mm, dd, yy] = parts.map(x => x.trim());
      if (!mm || !dd || !yy) return null;
      const month = +mm, day = +dd, y = +yy;
      let year = y;
      year += (yy.length === 2 ? (y >= 50 ? 1900 : 2000) : 0);
      const dt = new Date(year, month - 1, day);
      if (dt.getMonth() !== month - 1 || dt.getDate() !== day) return null;
      return dt;
    }
    const t = new Date(d);
    return isNaN(t.getTime()) ? null : t;
  }

  function weeksBetween(d1, d2) {
    return (d2 - d1) / (1000*60*60*24*7);
  }

  function getWeightKg(id, unitId) {
    const val = document.getElementById(id).valueAsNumber;
    const unit = document.getElementById(unitId).value;
    if (!(val > 0)) return NaN;
    return unit === 'lb' ? val * 0.45359237 : val;
  }

  function calculate() {
    const p = 1;
    const preopW   = getWeightKg('preopWeight','preopUnit');
    const aomW     = getWeightKg('aomWeight','aomUnit');
    const startW   = getWeightKg('startWeight','startUnit');
    const lastW    = getWeightKg('lastWeight','lastUnit');
    const currentW = getWeightKg('currentWeight','currentUnit');
    const lastDate = document.getElementById('lastVisitDate').value;
    const asOfStr  = document.getElementById('asOfDate').value;

    const msg = document.getElementById('message');
    const cards = document.getElementById('cards');

    if ([startW,lastW,currentW].some(v => !(v>0))) {
      msg.innerHTML = '<span class="error">Please enter valid weights.</span>';
      cards.hidden = true; return;
    }

    // calculations that don't depend on date
    const changeKg = currentW - lastW;
    const changeLb = changeKg * 2.20462;
    // Use AOM weight if provided, otherwise use program starting weight
    const aomOrStartW = (aomW > 0) ? aomW : startW;
    const tbwlPctSinceAOM = ((aomOrStartW - currentW) / aomOrStartW) * 100;
    const preopTbwlPct = (preopW > 0) ? ((preopW - currentW) / preopW) * 100 : null;

    // date-dependent calculations (only if date is provided)
    let hasDate = false;
    let avgLb = null;
    if (lastDate) {
      const lastVisit = parseDate(lastDate);
      const asOf = asOfStr ? parseDate(asOfStr) : new Date();
      if (!lastVisit || !asOf) {
        msg.innerHTML = '<span class="error">Invalid date.</span>';
        cards.hidden = true; return;
      }
      if (asOf < lastVisit) {
        msg.innerHTML = '<span class="error">As-of date before last visit.</span>';
        cards.hidden = true; return;
      }

      const weeks = weeksBetween(lastVisit, asOf);
      if (weeks === 0) {
        msg.innerHTML = '<span class="error">Dates are the same day.</span>';
        cards.hidden = true; return;
      }

      const avgKg = changeKg / weeks;
      avgLb = avgKg * 2.20462;
      hasDate = true;
    }

    // build output string
    let summary = `${fmt(Math.abs(changeKg),1)}kg/`+
                  `${fmt(Math.abs(changeLb),1)}lbs/`
    if (preopTbwlPct !== null) {
      summary += `TBW ${fmt(tbwlPctSinceAOM,1)}% since starting AOM`;
      summary += `/TBW ${fmt(preopTbwlPct,1)}% since surgery`;
    } else {
      summary += `TBW ${fmt(tbwlPctSinceAOM,1)}%`;
    }
    if (hasDate) {
      summary += `/average wt lost since last visit ${fmt(-avgLb,1)}lbs/wk`;
    }

    document.getElementById('sinceSummary').textContent = summary;

    cards.hidden = false;
    msg.textContent = '';
  }

  function resetForm() {
    document.getElementById('calc-form').reset();
    document.getElementById('cards').hidden = true;
    document.getElementById('message').textContent = 'Fill out the fields and click Calculate.';
    document.getElementById('asOfDate').value = '';
  }

  (function init(){
    const t=new Date();
    const yy=String(t.getFullYear()).substring(2);
    const mm=String(t.getMonth()+1).padStart(2,'0');
    const dd=String(t.getDate()).padStart(2,'0');
    document.getElementById('asOfDate').value = `${mm}${dd}${yy}`;
    
    // Add Enter key handler to form inputs
    const form = document.getElementById('calc-form');
    form.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && e.target.tagName !== 'BUTTON') {
        e.preventDefault();
        calculate();
      }
    });
  })();
</script>
</body>
</html>
